rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    /**
     * @Security - ADMIN CHECK (EXTREMELY SECURE)
     * Verifies user has 'admin' role in Firestore OR is the primary root admin.
     */
    function isAdmin() {
      return request.auth != null && (
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
         request.auth.token.email == 'admin@gmail.com'
      );
    }

    /**
     * @Security - OWNER CHECK
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @Collection - User Profiles
     * Owners can read/write their own profiles. Admins can manage all.
     */
    match /users/{userId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @Collection - Testimonies
     * Public can read APPROVED. Owners/Admins see ALL. 
     * Only Admins can moderate.
     */
    match /testimonies/{testimonyId} {
      allow read: if resource.data.approved == true || 
                     (request.auth != null && resource.data.uid == request.auth.uid) || 
                     isAdmin();
      allow create: if request.auth != null;
      allow update, delete: if isAdmin();
    }
    
    /**
     * @Collection - Prayer Requests
     * Public sees APPROVED+NON-PRIVATE. Owners/Admins see ALL.
     * Only Admins can moderate.
     */
    match /prayer_requests/{requestId} {
      allow read: if (resource.data.approved == true && resource.data.isPrivate == false) ||
                     (request.auth != null && resource.data.uid == request.auth.uid) ||
                     isAdmin();
      allow create: if request.auth != null;
      allow update, delete: if isAdmin();
    }

    /**
     * @Collection - Events
     * Public Read. Admin only Write.
     */
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @Collection - Bible Quizzes
     */
    match /bible_quizzes/{quizId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    /**
     * @Collection - Quiz Scores
     */
    match /quiz_scores/{scoreId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null;
    }
    
    /**
     * @Collection - Sermons & Gallery
     */
    match /sermons/{sermonId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /gallery/{imageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @Collection - Management Infrastructure
     */
    match /notifications/{notificationId} {
      allow read: if request.auth != null && (resource.data.uid == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    match /live_rooms/{roomId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
      
      match /messages/{messageId} {
        allow read, write: if request.auth != null;
      }
    }

    match /live_participants/{participantId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    /**
     * @Collection - Site Configuration
     * Public Read (Needed for unauthenticated access to contact/payment info). 
     * Admin Write.
     */
    match /site_settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /giving_stats/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @Collection - User Assets
     */
    match /user_bible_data/{docId} {
      allow read, write: if request.auth != null && docId.matches(request.auth.uid + '_.*');
    }

    /**
     * @Security - GLOBAL DENY (Absolute protection)
     */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}